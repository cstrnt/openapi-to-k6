import { InfoObject } from 'openapi3-ts/oas30';
import orval from 'orval';
import { formatAllFilesInDirectory, getPackageDetails, OutputOverrider } from './helper';
import { getK6ClientBuilder } from './k6SdkClient';
import { AnalyticsData } from './type';

const outputOverrider = OutputOverrider.getInstance();
const packageDetails = getPackageDetails();


const generatedFileHeaderGenerator = (info: InfoObject) => {
    return [
        `Automatically generated by ${packageDetails.name}: ${packageDetails.version}`,
        `Do not edit manually.`,
        ...(info.title ? [info.title] : []),
        ...(info.description ? [info.description] : []),
        ...(info.version ? [`OpenAPI spec version: ${info.version}`] : []),
    ]
};

export default async (openApiPath: string, outputDir: string, analyticsData?: AnalyticsData) => {
    /**
     * Note!
     * 1. override.requestOptions is not supported for the custom K6 client
     * 2. override.mutator is not supported for the custom K6 client
    */
    outputOverrider.redirectOutputToNullStream();

    await orval({
        input: openApiPath,
        output: {
            target: outputDir,
            mode: 'split',
            client: () => getK6ClientBuilder(analyticsData),
            override: {
                header: generatedFileHeaderGenerator,
            }
        }
    });

    outputOverrider.restoreOutput();

    await formatAllFilesInDirectory(outputDir);
};

